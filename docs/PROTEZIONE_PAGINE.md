# üîí Protezione Pagine Web con JWT

## üìã Come Funziona la Protezione

### **Principio Base**
**NESSUNA pagina √® accessibile senza un token JWT valido salvato in localStorage.**

---

## üõ°Ô∏è Livelli di Protezione

### **Livello 1: Protezione Globale (App.jsx)**

```javascript
// All'avvio dell'app
useAuth() ‚Üí Legge token da localStorage
         ‚Üí Se token esiste e valido: isAuthenticated = true
         ‚Üí Se token mancante o invalido: isAuthenticated = false

// Rendering condizionale
if (loading) {
  return <Caricamento...>  // Mentre verifica token
}

if (isAuthenticated) {
  return <Dashboard />      // ‚úÖ Mostra app protetta
}

return <Login />            // ‚ùå Mostra solo login
```

**Risultato**:
- **Senza token**: Vedi SOLO la pagina di login
- **Con token valido**: Vedi la dashboard appropriata al tuo ruolo

---

### **Livello 2: Protezione per Ruolo (ProtectedRoute)**

```javascript
<ProtectedRoute allowedRoles={['notaio']}>
  <Settings />
</ProtectedRoute>
```

**Cosa fa**:
1. Verifica che l'utente sia autenticato
2. Controlla che il ruolo utente sia in `allowedRoles`
3. Se OK ‚Üí mostra la pagina
4. Se KO ‚Üí mostra "Accesso Negato"

**Esempio**:
- **Cliente** prova ad aprire Settings ‚Üí ‚õî Accesso Negato
- **Notaio** apre Settings ‚Üí ‚úÖ Pagina visualizzata

---

## üîÑ Flow Completo di Protezione

### **Scenario 1: Utente NON loggato apre l'app**

```
1. User ‚Üí Apre http://localhost:3000
2. App carica
3. useAuth controlla localStorage
   ‚Üí Nessun token trovato
4. isAuthenticated = false
5. App.jsx mostra SOLO la pagina di Login
6. Tutte le altre pagine sono INACCESSIBILI
```

---

### **Scenario 2: Utente fa login**

```
1. User ‚Üí Inserisce email/password nel form di login
2. Frontend ‚Üí POST http://localhost:8000/api/auth/login/
3. Backend ‚Üí Verifica credenziali
4. Backend ‚Üí Genera JWT token
5. Frontend ‚Üí Salva token in localStorage:
   - localStorage.setItem('access_token', ...)
   - localStorage.setItem('refresh_token', ...)
   - localStorage.setItem('user', JSON.stringify({role: 'notaio', ...}))
6. useAuth ‚Üí isAuthenticated = true
7. App.jsx ‚Üí Mostra Dashboard (basata su ruolo)
8. ‚úÖ Utente ora pu√≤ navigare tutte le pagine
```

---

### **Scenario 3: Utente ricarica la pagina (F5)**

```
1. User ‚Üí Preme F5 (reload)
2. App ricarica
3. useAuth controlla localStorage
   ‚Üí Token trovato! ‚úÖ
4. isAuthenticated = true
5. App.jsx ‚Üí Mostra Dashboard (NON torna al login!)
6. Utente continua la sessione
```

**IMPORTANTE**: La sessione persiste anche dopo reload perch√© il token √® salvato in localStorage.

---

### **Scenario 4: Token scaduto (dopo 24 ore)**

```
1. User ‚Üí Fa una richiesta API (es. carica appuntamenti)
2. apiClient ‚Üí Aggiunge header: Authorization: Bearer {token_scaduto}
3. Backend ‚Üí Risponde 401 Unauthorized
4. apiClient ‚Üí Intercetta 401
5. apiClient ‚Üí Automatic refresh token:
   POST /api/auth/refresh/
   Body: { refresh: refresh_token }
6. Backend ‚Üí Ritorna nuovo access token
7. apiClient ‚Üí Salva nuovo token in localStorage
8. apiClient ‚Üí Riprova richiesta originale con nuovo token
9. ‚úÖ Richiesta va a buon fine
10. User ‚Üí Non nota nulla (tutto automatico!)
```

---

### **Scenario 5: Utente fa logout**

```
1. User ‚Üí Click su pulsante "Logout"
2. Frontend ‚Üí POST /api/auth/logout/ con token
3. Backend ‚Üí Aggiunge token a blacklist
4. Frontend ‚Üí localStorage.clear() (rimuove tutto)
5. useAuth ‚Üí isAuthenticated = false
6. App.jsx ‚Üí Mostra Login
7. ‚ùå Tutte le pagine sono di nuovo inaccessibili
8. Token vecchio √® INUTILIZZABILE per sempre
```

---

### **Scenario 6: Hacker prova ad accedere senza token**

```
1. Hacker ‚Üí Apre DevTools console
2. Hacker ‚Üí localStorage.clear() (cancella token)
3. App.jsx ‚Üí isAuthenticated = false
4. App.jsx ‚Üí Redirect automatico a Login
5. ‚ùå Hacker non pu√≤ accedere a NESSUNA pagina
```

---

### **Scenario 7: Hacker prova a modificare il token**

```
1. Hacker ‚Üí Copia token da localStorage
2. Hacker ‚Üí Modifica payload (es. role: "admin")
3. Hacker ‚Üí Salva token modificato in localStorage
4. Hacker ‚Üí Prova a fare richiesta API
5. Backend ‚Üí Verifica firma digitale del token
6. Backend ‚Üí Firma NON corrisponde! ‚ö†Ô∏è
7. Backend ‚Üí Risponde 401 Unauthorized
8. Frontend ‚Üí Rimuove token invalido
9. App.jsx ‚Üí Redirect a Login
10. ‚ùå Attacco fallito
```

---

### **Scenario 8: Cliente prova ad accedere a pagina Notaio**

```
1. Cliente ‚Üí Loggato come ruolo "cliente"
2. Cliente ‚Üí Token valido in localStorage
3. Cliente ‚Üí Prova ad aprire /settings (solo notai)
4. ProtectedRoute ‚Üí Controlla allowedRoles=['notaio']
5. ProtectedRoute ‚Üí user.role = 'cliente'
6. ProtectedRoute ‚Üí 'cliente' NOT IN ['notaio']
7. ProtectedRoute ‚Üí Mostra:
   ‚õî Accesso Negato
   Ruolo richiesto: notaio
   Tuo ruolo: cliente
8. ‚ùå Cliente NON pu√≤ accedere alla pagina
```

---

## üîê Tabella Protezioni Implementate

| Pagina/Funzionalit√† | Autenticazione | Ruolo Richiesto | Cosa succede senza auth |
|---------------------|----------------|-----------------|-------------------------|
| **Login** | ‚ùå No | Tutti | Sempre accessibile |
| **Forgot Password** | ‚ùå No | Tutti | Sempre accessibile |
| **Dashboard Cliente** | ‚úÖ S√¨ | `cliente` | Redirect a Login |
| **Dashboard Notaio** | ‚úÖ S√¨ | `notaio` | Redirect a Login |
| **Impostazioni** | ‚úÖ S√¨ | `notaio` | Accesso Negato se non notaio |
| **Documenti** | ‚úÖ S√¨ | `cliente`, `notaio` | Redirect a Login |
| **Messaggi** | ‚úÖ S√¨ | `cliente`, `notaio` | Redirect a Login |
| **API Calls** | ‚úÖ S√¨ | Dipende da endpoint | 401 Unauthorized |

---

## üîç Verifica Manuale Protezione

### **Test 1: Nessun Token**
```bash
# 1. Apri DevTools ‚Üí Application ‚Üí Local Storage
# 2. Cancella tutto
localStorage.clear()

# 3. Ricarica pagina (F5)
# RISULTATO: Vedi solo Login ‚úÖ
```

### **Test 2: Token Valido**
```bash
# 1. Fai login con credenziali valide
# 2. Apri DevTools ‚Üí Application ‚Üí Local Storage
# 3. Verifica presenza di:
#    - access_token
#    - refresh_token
#    - user

# RISULTATO: Dashboard visibile ‚úÖ
```

### **Test 3: Token Scaduto**
```bash
# 1. In localStorage, modifica access_token con uno scaduto
# 2. Prova a fare una richiesta API
# RISULTATO: Token refreshato automaticamente ‚úÖ
```

### **Test 4: Token Modificato**
```bash
# 1. In localStorage, modifica manualmente access_token
# 2. Ricarica pagina
# RISULTATO: Token invalidato, redirect a Login ‚úÖ
```

### **Test 5: Protezione Ruoli**
```bash
# 1. Login come Cliente
# 2. Prova manualmente ad accedere a Settings (solo Notai)
# RISULTATO: Accesso Negato ‚úÖ
```

---

## üìä Diagramma Protezione

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    APP START                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   useAuth()   ‚îÇ Legge localStorage
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ             ‚îÇ
        ‚Üì             ‚Üì
   ‚úÖ Token       ‚ùå No Token
    Valido
        ‚îÇ             ‚îÇ
        ‚Üì             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Dashboard  ‚îÇ ‚îÇ  Login   ‚îÇ
‚îÇ  (protetta) ‚îÇ ‚îÇ (public) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ Cliente role ‚Üí Dashboard Cliente
       ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ Notaio role ‚Üí Dashboard Notaio
                           ‚îÇ
                           ‚îú‚îÄ‚îÄ‚îÄ Dashboard ‚úÖ
                           ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ Settings (ProtectedRoute)
                                 ‚îÇ
                                 ‚îú‚îÄ‚îÄ‚îÄ Notaio ‚úÖ
                                 ‚îÇ
                                 ‚îî‚îÄ‚îÄ‚îÄ Altri ‚õî Accesso Negato
```

---

## üõ†Ô∏è Codice Chiave

### **1. Verifica Token all'Avvio (useAuth.jsx)**

```javascript
useEffect(() => {
  const loadUser = () => {
    const token = authService.getAccessToken()
    const user = authService.getUser()

    if (token && user) {
      // ‚úÖ Token presente
      setIsAuthenticated(true)
      setUser(user)
    } else {
      // ‚ùå Nessun token
      setIsAuthenticated(false)
    }
    setLoading(false)
  }

  loadUser()
}, [])
```

### **2. Rendering Condizionale (App.jsx)**

```javascript
// Mostra loading
if (loading) {
  return <Caricamento />
}

// Se autenticato ‚Üí Dashboard
if (isAuthenticated) {
  return (
    <ProtectedRoute>
      {user.role === 'notaio' ? <DashboardNotaio /> : <Dashboard />}
    </ProtectedRoute>
  )
}

// Altrimenti ‚Üí Login
return <Login />
```

### **3. Protezione Ruoli (ProtectedRoute.jsx)**

```javascript
function ProtectedRoute({ children, allowedRoles = [] }) {
  const { isAuthenticated, user } = useAuth()

  // Nessun token
  if (!isAuthenticated) {
    return null
  }

  // Token OK ma ruolo sbagliato
  if (allowedRoles.length > 0 && !allowedRoles.includes(user?.role)) {
    return <AccessoDenegato />
  }

  // Tutto OK
  return children
}
```

### **4. API con Auto-Refresh (apiClient.js)**

```javascript
async request(endpoint, options) {
  const token = authService.getAccessToken()
  const response = await fetch(url, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      ...options.headers
    }
  })

  // Token scaduto?
  if (response.status === 401) {
    // Auto-refresh
    const newToken = await authService.refreshAccessToken()
    // Riprova richiesta
    return this.request(endpoint, options)
  }

  return response.json()
}
```

---

## ‚úÖ Checklist Sicurezza

- [x] Token JWT salvato in localStorage
- [x] Token verificato ad ogni avvio app
- [x] Nessuna pagina accessibile senza token
- [x] Token con scadenza (24h access, 30d refresh)
- [x] Refresh automatico token scaduti
- [x] Logout invalida token permanentemente (blacklist)
- [x] Protezione basata su ruoli
- [x] API calls con auto-refresh
- [x] Token firmati digitalmente (non modificabili)
- [x] Gestione errori 401/403

---

## üéØ Riassunto

### **Senza Token JWT Valido:**
- ‚ùå Dashboard inaccessibile
- ‚ùå Settings inaccessibile
- ‚ùå API calls falliscono
- ‚úÖ SOLO Login accessibile

### **Con Token JWT Valido:**
- ‚úÖ Dashboard accessibile
- ‚úÖ Navigazione funzionante
- ‚úÖ API calls autorizzate
- ‚úÖ Refresh automatico se scade
- ‚úÖ Ruoli verificati per pagine specifiche

### **Al Logout:**
- ‚ùå Token distrutto permanentemente
- ‚ùå Tutte le pagine tornano inaccessibili
- ‚úÖ Redirect automatico a Login

---

**La protezione √® COMPLETA e ATTIVA su TUTTE le pagine!** üéâüîí

